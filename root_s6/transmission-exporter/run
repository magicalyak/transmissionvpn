#!/usr/bin/with-contenv bash
# shellcheck shell=bash

# Check if transmission exporter is enabled
if [[ "${TRANSMISSION_EXPORTER_ENABLED,,}" != "true" ]]; then
    echo "[transmission-exporter] Exporter is disabled. Set TRANSMISSION_EXPORTER_ENABLED=true to enable."
    sleep infinity
    exit 0
fi

echo "[transmission-exporter] Starting Transmission Prometheus exporter on port ${TRANSMISSION_EXPORTER_PORT}"

# Set up exporter arguments
EXPORTER_ARGS="-web.listen-address=:${TRANSMISSION_EXPORTER_PORT}"

# Add transmission RPC endpoint
EXPORTER_ARGS="${EXPORTER_ARGS} -transmission.addr=http://127.0.0.1:9091/transmission/rpc"

# Add authentication if configured
if [[ -n "${TRANSMISSION_RPC_USERNAME}" ]] && [[ -n "${TRANSMISSION_RPC_PASSWORD}" ]]; then
    echo "[transmission-exporter] Using RPC authentication"
    EXPORTER_ARGS="${EXPORTER_ARGS} -transmission.username=${TRANSMISSION_RPC_USERNAME}"
    EXPORTER_ARGS="${EXPORTER_ARGS} -transmission.password=${TRANSMISSION_RPC_PASSWORD}"
fi

# Start the exporter
exec s6-setuidgid abc /usr/local/bin/transmission-exporter ${EXPORTER_ARGS} 